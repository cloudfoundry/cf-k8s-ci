common:
  on_failure: &slackHook
  - put: slack
    params:
      attachments: |2
          [{
              "color": "danger",
              "actions": [
                    {
                      "type": "button",
                      "text": "View in Concourse",
                      "url": "https://ci.cf-k8s.cf/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME"
                    }
              ]
          }]
      channel: '#korifi-ci'
      text: |
        Pipeline *$BUILD_PIPELINE_NAME* failed :cry:

        Job is *$BUILD_JOB_NAME*
        Build name is *$BUILD_NAME*

groups:
- name: main
  jobs:
  - bump-major-version
  - bump-minor-version
  - bump-patch-version
  - publish-release

jobs:
- name: bump-major-version
  plan:
  - get: korifi-version
    params:
      bump: major
  - params:
      file: korifi-version/version
    put: korifi-version
  on_failure: *slackHook

- name: bump-minor-version
  plan:
  - get: korifi-version
    params:
      bump: minor
    passed:
    - publish-release
    trigger: true
  - params:
      file: korifi-version/version
    put: korifi-version
  on_failure: *slackHook

- name: publish-release
  plan:
  - in_parallel:
      steps:
      - get: korifi-ci
      - get: korifi-controllers
      - get: korifi-version
  - task: create-relese
    config:
      file: korifi-ci/pipelines/tasks/create-release.yml
      image: ci-image
      params:
        CLUSTER_NAME: pr-e2e
        GCP_ZONE: europe-west1-b
  # - put: korifi-github-release
  #   params:
  #     globs:
  #     - release-output/korifi*.tgz
  #     name: korifi-version/version
  #     tag: korifi-version/version
  #     tag_prefix: v
  on_failure: *slackHook

resource_types:
- name: slack-notification
  type: registry-image
  source:
    username: ((docker.user))
    password: ((docker.pass))
    repository: cfcommunity/slack-notification-resource
    tag: latest

resources:
- name: korifi-ci
  type: git
  icon: git
  source:
    uri: https://github.com/cloudfoundry/korifi-ci.git
    branch: main

- name: korifi-controllers
  type: git
  icon: git
  source:
    branch: main
    private_key: ((github/korifi-controllers.private_key))
    uri: git@github.com:cloudfoundry/korifi-controllers.git

# - name: korifi-github-release
#   type: github-release
#   icon: egg-easter
#   source:
#     access_token: ((github/korifi-controllers.access_token))
#     drafts: true
#     owner: cloudfoundry
#     repository: korifi-controllers

- name: korifi-version
  type: semver
  icon: counter
  source:
    branch: main
    driver: git
    file: korifi-release-test/version
    initial_version: 0.1.0
    private_key: ((github/cf-k8s-secrets.private_key))
    uri: ((github/cf-k8s-secrets.uri))
